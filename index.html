<!DOCTYPE html>
<html>
<head>
  <title>TON Auth</title>
  <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    button {
      padding: 12px 24px;
      background: #0088cc;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      margin: 20px 0;
    }
    #status {
      margin: 20px 0;
      color: #666;
    }
    #error {
      color: red;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>üîë Connect Tonkeeper</h1>
  <button id="connect-button" disabled>Connect Wallet</button>
  <p id="status">Loading Telegram WebApp...</p>
  <p id="error"></p>

  <script>
    function initializeApp() {
      const status = document.getElementById('status');
      const error = document.getElementById('error');
      const connectButton = document.getElementById('connect-button');

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É TonConnect
      if (typeof TonConnect === 'undefined') {
        status.textContent = "Error: TonConnect SDK not loaded";
        error.textContent = "Please check your internet connection";
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É Telegram WebApp
      if (!window.Telegram?.WebApp) {
        status.textContent = "Error: Telegram WebApp not loaded";
        error.textContent = "Please open this page in Telegram app";
        return;
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram WebApp
      try {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
      } catch (e) {
        error.textContent = `WebApp init error: ${e.message}`;
        return;
      }

      // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
      const connector = new TonConnect.TonConnect({
        manifestUrl: 'https://tonkeeper-bot.vercel.app/tonconnect-manifest.json'
      });

      connectButton.addEventListener('click', async () => {
        try {
          status.textContent = "Connecting...";
          const wallets = await connector.getWallets();
          await connector.connect(wallets[0]);
        } catch (err) {
          status.textContent = `Error: ${err.message}`;
        }
      });

      connector.onStatusChange((wallet) => {
        if (wallet) {
          Telegram.WebApp.sendData(wallet.account.address);
          Telegram.WebApp.close();
        }
      });

      connectButton.disabled = false;
      status.textContent = "Ready to connect!";
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ Telegram WebApp —Å fallback
    function loadTelegramWebApp() {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@telegram/web-app@6.7.0/dist/telegram-web-app.js';
      script.onload = initializeApp;
      script.onerror = () => {
        // Fallback –Ω–∞ unpkg
        const fallbackScript = document.createElement('script');
        fallbackScript.src = 'https://unpkg.com/@telegram/web-app@6.7.0/dist/telegram-web-app.js';
        fallbackScript.onload = initializeApp;
        fallbackScript.onerror = () => {
          document.getElementById('status').textContent = "Failed to load Telegram WebApp";
          document.getElementById('error').textContent = "Please try again later or open in Telegram app";
        };
        document.head.appendChild(fallbackScript);
      };
      document.head.appendChild(script);
    }

    // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    loadTelegramWebApp();
  </script>
</body>
</html>